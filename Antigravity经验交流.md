
**使用Antigravity的体验：**
- AI生成的代码review很痛苦
- 代码回退比较困难
- Gemini 3 Flash使用量也有限制

解决方法：
- 代码回退比较困难，可以使用git来管理代码
- Gemini 3 Flash使用量也有限制，用不同帐户交叉使用


**程序提示词**
用python写一个股票购买策略的回测程序。该程序根据股票买卖策略对指定个股的历史数据进行模拟交易，并展示交易结果。

**程序模块**
1. 配置模块config.py，通过读写配置文件获取所有配置项
2. 数据模块data.py，通过akshare接口获取指定个股数据
3. 策略模块strategy.py，判断是否为买点或者卖点，以及如何进行买卖。
4. 回测模块backtest.py，遍历指定个股的历史数据，调用策略接口进行买卖，对买卖结果进行统计分析
5. UI模块ui.py，编写一个用户交互页面，该页面支持读写config的配置，支持查看回测结果
6. 主模块astock_single.py, 调用上述模块，避免在主模块编写太多复杂的逻辑代码。

**配置模块**
- save_offline_data: 是否本地保存离线数据
- target_stock_code: 要测试的个股代码，多个个股用分号隔开
- backtest_year: 回测的年数（比如3代表对过去3年的历史数据进行回测）
- kline_strategy: K线策略配置。
  - 日均线为DMA，周k线为WMA，月k线为MMA，D5MA代表5日均线，W5MA代表5周均线，M5MA代表5个月均线，依此类推。DMA-1代表前一个交易日的收盘价，D5MA-1代表前一个交易日的5日均线，W5MA-1代表前一个交易日的5周均线，M5MA-1代表前一个交易日的5个月均线，依此类推。
  - 支持与(&&)、或(||)、非(!)、大于（>）、小于(<)、等于（==）和不等（!=）操作。
  - 支持*配置，(D5MA > D30MA) * 3, 代表连续3个交易日5日均线在30日均线之上，该配置本质上等于(D5MA > D30MA) && (D5MA-1 > D30MA-1) && (D5MA-2 > D30MA-2)。WMA和MMA同理。
  - DMA、WMA、MMA可以通过与(&&)、或(||)、非(!)、大于（>）、小于(<)、等于（==）和不等（!=）以及*来进行逻辑整合。 比如((M5MA > M10MA > M20MA) * 3) && (W10MA > W30MA) || ((D5MA > D10MA) * 2)。
- trade_strategy: 交易策略配置。
  - 支持大于（>）、小于(<)、等于（==）和不等（!=）操作。
  - 日K线用DK表示，周K线用WK表示，月K线用MK表示。(DK < -2%) 代表日k线较前一个交易日降低2%，同理(WK < -5%) 代表周k线较前一周降低5%。
  - 买策略用BUYS代表，卖策略用SELL代表。
  - 卖策略可以设置两个百分比止盈GAIN和止损LOSS和一个时间投资周期PERIOD，比如GAIN设置5%，代表当价格比买入价格高5%就止盈卖出，LOSS设置10%代表股价比买入点亏损10%则止损卖出。 PERIOD为单笔买入最长持有周期（用交易日来判断），PERIOD设置为60，代表某个股票买入后60个自然日（差不多两个月）如果没有止盈或止损也强制卖出。

**数据模块**
输入：配置文件、目标股票代码
处理：
- 当配置为不本地保存离线数据， 则通过调用https://github.com/akfamily/akshare 这个库的接口来获取目标股票的历史k线数据，并将数据反馈给调用方。
- 如果配置为本地保存离线数据，则先查看本地是否有对应离线文件，如有，则查看数据是否更新到最新，如果最新就用本地离线数据，如果不是最新则调用akshare的接口获取最新数据并同步更新到本地，并将数据反馈给调用方。
- 获取的数据包括股票从上市以来的所有日k线，周k线，月k线数据。比如某股票在1998年3月上市，那就要从上市之后的所有k线都获取，并根据配置保存到本地。
输出：目标股票k线数据

**策略模块**
K线策略用于判断股票是否是上升行情，交易策略判断当天是否买卖股票。只有k线策略返回True且符合交易策略的买卖规则，则开展股票买卖。
- K线策略
输入：配置文件、目标股票代码、交易日日期、股票k线数据
处理：根据输入及股票k线数据，基于配置的策略判断是否为上升行情，上升行情结果为True，非上升行情结果为False
输出：True 或者 False
 
- 交易策略
输入：配置文件、目标股票代码、交易日时间日期、交易记录、股票k线数据
处理：调用K线策略，判断股票在上升行情时，且符合BUYS配置的规则，则输出买入交易动作；如果符合SELL配置的规则，则输出卖出交易动作
输出：是否执行交易动作、执行什么动作（买入还是卖出）、买入的输出包含：记录交易日期、交易类型、股票名称、股票代码、买入价格；卖出的输出包含：记录交易日期、交易类型、股票名称、股票代码、卖出价格、卖出原因（止盈/止损/到期）、从买入到卖出的时间周期

**回测模块**
输入：配置文件、目标股票代码、股票k线数据
处理：读取配置获取回测年数，以当前时间往前倒退到回测年数为开始，如果上市时间小于回测年数则取有效的开始时间即可。从前往后遍历从开始时间的所有交易日，并判断遍历到的交易日是否符合K线策略配置，比如遍历到2025年11月6日，则认为2025年11月6日是最新的交易日，不能以之后的数据作为交易参考。接下来调用交易策略并获取结果，如果有交易动作，无论买卖都将交易动作记录在本地交易记录文件中。
输出：交易记录、交易记录的统计分析结果（包括历史有几次交易；投资止盈的次数占所有投资次数的比例也就是赢率；以100万为初始交易资金，历史交易投资回报率；平均每次交易用时多少个自然日。）

**UI模块**
输入：配置文件、交易记录、交易记录的统计分析结果
配置功能：提供一个简约、操作友好而且美观的WEB页面，供用户读写配置文件。
回测及结果展示：有开始回测按钮，点击开始回测按钮，开始回测；，支持对交易记录（包括买入日期、股票代码、股票名称、买入价格，预期回报率、卖出日期、卖出价格、本次交易盈亏金额、本次交易盈利百分比、卖出原因（止盈/止损/到期）、从买入到卖出的时间周期）、交易记录的统计分析结果（包括历史有几次交易；投资止盈的次数占所有投资次数的比例也就是赢率；以100万为初始交易资金，历史交易投资回报率；平均每次交易用时多少个自然日。）做一个美观的展示。